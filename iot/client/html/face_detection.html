<!DOCTYPE html>
<html>
<head>
  <title>remote iot-red control</title>
  <link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <script src="./scripts/jquery.min.js"></script>
  <script src="./bootstrap/js/bootstrap.min.js"></script>
  <script src="./scripts/bootbox.min.js"></script>
  <script src="./scripts/socket.io.js"></script>
  <script src="./scripts/RGraph/RGraph.common.core.js" ></script>
  <script src="./scripts/RGraph/RGraph.common.dynamic.js" ></script>
  <script src="./scripts/RGraph/RGraph.meter.js" ></script>
</head>
<body>

<div class="panel panel-default ">

  <div class="panel-heading">
    <h3 class="panel-title" id="servInfo">Server(unkown) Status</h3>
  </div>

  <div class="panel-body">
    <div class="row">
      <div class="col-md-7">
        <div class="alert alert-success" role="alert" id="servStat">disconnected</div>
      </div>
    </div>
  </div>

</div>

<div class="panel panel-default">

  <div class="panel-heading">
    <h3 class="panel-title">Start Face Detection</h3>
  </div>

  <div class="panel-body">

    <div class="row">
      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-addon" id="basic-addon1">Method</span>
          <input type="text" class="form-control" placeholder="'face_detection_GEN'" aria-describedby="basic-addon2" id="method" value="face_detection_GEN">
        </div>
      </div>

      <div class="col-md-3">
        <div class="input-group">
        <span class="input-group-addon" id="basic-addon1">Params</span>
          <input type="text" class="form-control" placeholder="[1, 0, null]" aria-describedby="basic-addon2" id="params", value='[200, null]'>
        </div>    
      </div>

      <div class="col-md-1">
        <button type="button" class="btn btn-danger" id="submit">Submit</button>
      </div>
    </div>

    </div>
</div>

<div class="panel panel-default">

  <div class="panel-heading">
    <h3 class="panel-title">Watch Camera</h3>
  </div>

  <div class="panel-body">
    <div class="row">

      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-btn">
            <button class="btn btn-danger" type="button" id="query">Query</button>
          </span>
          <input type="text" class="form-control" placeholder="queryMethod" id="queryMethod" value="face_detection_GEN">
        </div><!-- /input-group -->
      </div>

      <div class="col-md-4">
        <div class="alert alert-success" role="alert" id="queryReturn">No Face</div>
      </div>

    </div>
    <div class="row">
      <div class="col-md-1">
          <canvas id="cvs" width="600" height="250" style="border-radius: 15px">[No canvas support]</canvas> 
      </div>    
    </div>
  </div>

</div>

<script type="text/javascript">

    servConfig = {'port': 3000};

    function connServ() {
        var socket = io('http://' + servConfig.ip + ':' + servConfig.port);

        socket.on('connect', function() {

            $('#servStat').text('connected');

            $('#submit').click(function(){
                socket.emit('iot-input', {
                    'method': $('#method').val(),
                    'params': $('#params').val()
                })

            });

            $('#query').click(function(){
              setInterval(function() {
                socket.emit('iot-output', {
                    'method': $('#queryMethod').val()
                })
              }, 500);
            })

            var cvs = $('#cvs')[0];
            var context = cvs.getContext('2d');
            var img = new Image();

            function clearCanvas() {
                context.fillStyle = '#FFffFF';
                context.fillRect(0, 0, 600, 250);
            }

            clearCanvas();

            function loadDataUrl(data) {
                img.src = data;
                context.drawImage(img, 0, 0);
            }

            socket.on('iot-output', function(msg) {
                $('#queryReturn').text("No valid return");

                if(msg && msg.method == $('#queryMethod').val() 
                  && msg.callback) {
                    var cb = msg.callback
                    var num = cb.args[0];
                    var dataurl = cb.args[1];

                    if(num <= 0)
                        clearCanvas();
                    else
                        loadDataUrl(dataurl);

                    $('#queryReturn').text('Found ' + cb.args[0] + ' face');
                }
                socket.emit('iot-output', {
                    'method': $('#queryMethod').val()
                })

            })
        });

        socket.on('disconnect', function(){
            $('#servStat').text('disconnected');    
        });
    }

    bootbox.prompt("Input server ip and default is localhost",function(data) {    

      servConfig.ip = (data)?data:'localhost';

      $('#servInfo').text('Server ( ' + servConfig.ip + ' ) Status');

      connServ();
    });


    
</script>
</body>